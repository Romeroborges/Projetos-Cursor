generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  GERENTE
  ATENDENTE
  CAIXA
}

enum TableStatus {
  LIVRE
  OCUPADO
  AGUARDANDO_PAGAMENTO
}

enum OrderIdentificationType {
  MESA
  CLIENTE
}

enum OrderStatus {
  ABERTO
  EM_ANDAMENTO
  FECHADO
}

enum CashRegisterStatus {
  ABERTO
  FECHADO
}

enum PaymentMethod {
  CREDITO
  DEBITO
  PIX
  DINHEIRO
}

enum AuditAction {
  ABERTURA_CAIXA
  FECHAMENTO_CAIXA
  FECHAMENTO_COMANDA
  SANGRIA
  REFORCO
  AJUSTE_ESTOQUE
  CANCELAMENTO_ITEM
  CANCELAMENTO_COMANDA
}

enum CashMovementType {
  SANGRIA
  REFORCO
}

model User {
  id        String   @id @default(cuid())
  nome      String
  email     String   @unique
  hashSenha String   @map("hash_da_senha")
  papel     UserRole
  ativo     Boolean  @default(true)
  criadoEm  DateTime @default(now()) @map("criado_em")

  ordensAbertas   Order[]        @relation("OrderOpenedBy")
  caixasAbertos   CashRegister[]
  movimentosCaixa CashMovement[]
  auditLogs       AuditLog[]

  @@map("usuarios")
}

model Table {
  id           String      @id @default(cuid())
  nomeOuNumero String      @unique @map("nome_ou_numero")
  status       TableStatus @default(LIVRE)
  criadoEm     DateTime    @default(now()) @map("criado_em")

  ordens Order[]

  @@map("mesas")
}

model Order {
  id                String                  @id @default(cuid())
  tipoIdentificacao OrderIdentificationType @map("tipo_de_identificacao")
  tableId           String?                 @map("id_da_tabela")
  nomeCliente       String?                 @map("nome_do_cliente")
  status            OrderStatus             @default(ABERTO)
  abertoPorId       String                  @map("aberto_por")
  abertoEm          DateTime                @default(now()) @map("aberto_em")
  fechadoEm         DateTime?               @map("fechado_em")
  valorTotal        Int                     @default(0) @map("valor_total")

  table     Table? @relation(fields: [tableId], references: [id])
  abertoPor User   @relation("OrderOpenedBy", fields: [abertoPorId], references: [id])

  itens      OrderItem[]
  pagamentos Payment[]

  @@index([status])
  @@index([abertoEm])
  @@map("ordens")
}

model Product {
  id              String   @id @default(cuid())
  nome            String
  categoria       String
  preco           Int      @map("preco")
  controlaEstoque Boolean  @default(false) @map("controle_de_estoque")
  ativo           Boolean  @default(true)
  criadoEm        DateTime @default(now()) @map("criado_em")

  estoque Stock?
  itens   OrderItem[]

  @@index([categoria])
  @@map("produtos")
}

model OrderItem {
  id            String    @id @default(cuid())
  orderId       String    @map("id_do_pedido")
  productId     String    @map("id_do_produto")
  quantidade    Int
  observacao    String?   @map("observacao")
  precoUnitario Int       @map("preco_unitario")
  precoTotal    Int       @map("preco_total")
  criadoEm      DateTime  @default(now()) @map("criado_em")
  canceladoEm   DateTime? @map("cancelado_em")

  order   Order   @relation(fields: [orderId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@map("itens_pedido")
}

model Stock {
  id               String   @id @default(cuid())
  productId        String   @unique @map("id_do_produto")
  quantidadeAtual  Int      @default(0) @map("quantidade_atual")
  quantidadeMinima Int      @default(0) @map("quantidade_minima")
  atualizadoEm     DateTime @updatedAt @map("atualizado_em")

  product Product @relation(fields: [productId], references: [id])

  @@map("estoque")
}

model CashRegister {
  id           String             @id @default(cuid())
  abertoPorId  String             @map("aberto_por")
  abertoEm     DateTime           @default(now()) @map("aberto_em")
  fechadoEm    DateTime?          @map("fechado_em")
  valorInicial Int                @map("valor_inicial")
  valorFinal   Int?               @map("valor_final")
  status       CashRegisterStatus @default(ABERTO)

  abertoPor  User           @relation(fields: [abertoPorId], references: [id])
  auditLogs  AuditLog[]
  movimentos CashMovement[]

  @@index([status])
  @@map("caixa_registradora")
}

model CashMovement {
  id             String           @id @default(cuid())
  cashRegisterId String           @map("id_caixa")
  userId         String?          @map("id_usuario")
  tipo           CashMovementType
  valor          Int
  motivo         String?
  criadoEm       DateTime         @default(now()) @map("criado_em")

  cashRegister CashRegister @relation(fields: [cashRegisterId], references: [id])
  user         User?        @relation(fields: [userId], references: [id])

  @@index([cashRegisterId])
  @@index([criadoEm])
  @@map("movimentos_caixa")
}

model Payment {
  id      String        @id @default(cuid())
  orderId String        @map("id_do_pedido")
  metodo  PaymentMethod
  valor   Int
  pagoEm  DateTime      @default(now()) @map("pago_em")

  order Order @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@map("pagamentos")
}

model AuditLog {
  id             String      @id @default(cuid())
  userId         String?     @map("id_usuario")
  cashRegisterId String?     @map("id_caixa")
  action         AuditAction
  detailsJson    String?     @map("detalhes_json")
  criadoEm       DateTime    @default(now()) @map("criado_em")

  user         User?         @relation(fields: [userId], references: [id])
  cashRegister CashRegister? @relation(fields: [cashRegisterId], references: [id])

  @@index([criadoEm])
  @@map("registros")
}
